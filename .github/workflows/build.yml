name: Build MindTheGapps

on:
  workflow_dispatch:

jobs:
  matrix:
    name: Generate build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setup.outputs.matrix }}
    steps:
      - name: Generate build matrix
        id: setup
        uses: actions/github-script@v6
        with:
          script: |
            let matrix = {};
            matrix.arch = ["arm64", "x86_64"]
            core.setOutput("matrix", JSON.stringify(matrix));

  build:
    name: 13.0.0-${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: matrix
    strategy:
      matrix: ${{ fromJson(needs.matrix.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Clone repository
        run: git clone -b tau https://gitlab.com/MindTheGapps/vendor_gapps.git/ --depth 1

      - name: Build
        working-directory: vendor_gapps
        run: |
          echo "date=$(date -u +%Y%m%d)" >> $GITHUB_ENV
          cp -f ../build.sh build/gapps.sh
          ./build/gapps.sh ${{ matrix.arch }}

      - name: Release
        uses: softprops/action-gh-release@v0.1.15
        with:
          tag_name: ${{ env.date }}
          fail_on_unmatched_files: true
          files: vendor_gapps/out/*.zip
          body: Updated on ${{ env.date }}
